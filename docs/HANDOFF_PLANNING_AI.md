# 기획 AI 에이전트 핸드오프 문서

## 프로젝트 개요

### 프로젝트 목적

**260대의 Android 스마트폰을 동시에 제어하는 분산 자동화 시스템**을 구축하는 것이 목표입니다.

### 핵심 요구사항

1. **자동화 작업**: 3가지 커맨드(COMMAND_A, COMMAND_B, COMMAND_C)를 순환 실행
2. **검색 요청 시스템**: 사용자가 키워드/제목/URL을 입력하면 우선적으로 처리하는 검색 기능
3. **버퍼 스케줄러**: 검색 요청이 있을 때 자동화 작업을 버퍼로 활용하여 요청 간 간격 유지
4. **분산 아키텍처**: 제어서버(VM) → 워커PC(2대) → Android 기기(260대) 구조
5. **실시간 모니터링**: 웹 대시보드를 통한 시스템 상태 및 작업 진행 상황 확인

---

## 현재까지 구축된 내용

### ✅ 완료된 기능

#### 1. 제어서버 (Control Server)

**기술 스택**: Node.js + TypeScript + Express.js + WebSocket + Redis

**주요 기능**:
- ✅ REST API 서버 (Express.js)
- ✅ WebSocket 서버 (`/ws` 엔드포인트)
- ✅ JWT 기반 인증 시스템
- ✅ Redis를 활용한 디바이스 상태 관리
- ✅ 작업 큐 및 분배 시스템
- ✅ 검색 요청 관리 서비스
- ✅ 버퍼 스케줄러 (검색 요청 + 자동화 작업 번갈아 실행)
- ✅ 정적 파일 서빙 (웹 대시보드)

**주요 엔드포인트**:
- `POST /api/auth/login` - 로그인
- `POST /api/search-requests` - 검색 요청 등록
- `GET /api/search-requests/:id` - 검색 요청 상태 조회
- `GET /api/scheduler/status` - 스케줄러 상태 조회
- `POST /api/scheduler/start` - 스케줄러 시작
- `POST /api/scheduler/stop` - 스케줄러 중지

**파일 구조**:
```
apps/control-server/
├── src/
│   ├── api/
│   │   └── server.ts          # Express + WebSocket 서버
│   ├── services/
│   │   ├── authService.ts     # 인증 서비스
│   │   ├── deviceManager.ts   # 디바이스 상태 관리
│   │   ├── taskExecutor.ts    # 작업 실행 및 분배
│   │   ├── searchRequestService.ts  # 검색 요청 관리
│   │   └── bufferScheduler.ts # 버퍼 스케줄러
│   └── commands/              # 커맨드 정의
```

#### 2. 워커 에이전트 (Worker Agent)

**기술 스택**: Node.js + TypeScript + WebSocket Client

**주요 기능**:
- ✅ 제어서버와 WebSocket 연결
- ✅ 기기 스캔 및 등록 (ADB 기반)
- ✅ 자동화 커맨드 실행 (COMMAND_A/B/C)
- ✅ 검색 요청 실행 (3단계 폴백: 키워드 → 제목 → URL)
- ✅ 재시도 로직 (최대 3회)
- ✅ 스크린샷 캡처 (오류 발생 시)
- ✅ 동시 실행 제한 (Semaphore)

**파일 구조**:
```
apps/worker-agent/
├── src/
│   ├── workerAgent.ts         # 워커 에이전트 메인
│   ├── adbController.ts       # ADB 명령 인터페이스
│   ├── commandExecutor.ts     # 자동화 커맨드 실행
│   └── searchCommand.ts       # 검색 커맨드 실행
```

**현재 상태**:
- 검색 커맨드는 **시뮬레이션 모드**로 구현됨 (실제 앱 연동은 TODO)
- 실제 ADB 명령 구조는 준비되어 있으나 앱 패키지명/좌표 설정 필요

#### 3. 웹 대시보드 (Admin Web)

**기술 스택**: HTML + JavaScript (Vanilla) + Web Awesome (UI 컴포넌트)

**주요 기능**:
- ✅ 로그인 UI
- ✅ 대시보드 (디바이스 통계, 스케줄러 상태)
- ✅ 검색 요청 등록 폼
- ✅ 검색 요청 목록 및 상태 확인
- ✅ 스케줄러 제어 (시작/중지)
- ✅ 비밀번호 변경

**파일 구조**:
```
apps/admin-web/
├── index.html
├── app.js
├── styles.css
└── package.json
```

#### 4. 문서화

- ✅ `docs/ARCHITECTURE.md` - 전체 아키텍처 문서
- ✅ `docs/SEARCH_REQUEST_FLOW.md` - 검색 요청 플로우 상세
- ✅ `docs/setup/POC_SETUP.md` - PoC 설정 가이드
- ✅ `docs/setup/QUICK_START.md` - 빠른 시작 가이드

---

## 현재 아키텍처 (문서 기준)

### 네트워크 토폴로지

```
외부 인터넷 (VPN)
    ↓
VM 중계 제어서버 (24/7)
    ↓
워커PC #1 (130대) ──┐
                    ├── WiFi Router #1 (192.168.1.0/24)
워커PC #2 (130대) ──┘
                    ├── WiFi Router #2 (192.168.2.0/24)
                    │
                Android 스마트폰 260대
```

### 하드웨어 구성 (문서 기준)

| 구성요소 | 문서상 사양 | 상태 |
|---------|------------|------|
| 제어서버 VM | Ubuntu 22.04 LTS, 8 Core, 16GB RAM | ⚠️ **재검토 필요** |
| 워커PC | Ubuntu 22.04 LTS, 16 Core, 64GB RAM | ❌ **Windows로 변경 확정** |
| WiFi 라우터 | 150+ 클라이언트 지원, 폐쇄망 | ✅ 확정 |
| Android 기기 | 260대, USB 디버깅 가능 | ✅ 확정 |

---

## 🔴 결정/판단이 필요한 주요 사항

### 1. 제어서버 운영체제 선택

**현재 상황**:
- 문서(`ARCHITECTURE.md`)에는 **Ubuntu 22.04 LTS**로 명시되어 있음
- 하지만 최근 검토 요청이 들어옴

**고려사항**:
- 제어서버는 Node.js/Express 기반으로 OS 의존성이 낮음
- 워커PC가 Windows로 확정되면서 통합성 고려 필요
- VPN 서버(WireGuard) 운영 편의성
- 모니터링 도구(Grafana, Prometheus) 운영 편의성
- 클라우드 배포 시 호환성 (AWS EC2, Azure VM, GCP)

**질문**:
- 제어서버는 Ubuntu를 유지할지, Windows Server로 변경할지?
- 클라우드 배포 계획이 있는지? (AWS/Azure/GCP 선택)
- VPN 서버 운영 경험이 있는지?

---

### 2. Windows 기반 멀티제어 툴 통합 방법

**현재 상황**:
- **워커PC는 Windows로 확정됨** ✅
- 폰보드 제조사에서 제공하는 **EXE 형태의 멀티제어 툴** 사용 예정
- 해당 툴 기능:
  - ADB 명령 실행
  - 화면 병합/관리
  - 화면 관리
  - 기타 제조사 특화 기능

**현재 구현**:
- 워커 에이전트는 **Node.js**로 작성됨
- ADB 명령은 `adbController.ts`에서 직접 `child_process.exec`로 실행
- 제조사 툴과의 통합 방법이 미정

**고려사항**:
- 제조사 툴이 제공하는 API/인터페이스 형태
  - CLI 명령줄 인터페이스인지?
  - COM/COM+ 인터페이스인지?
  - HTTP API 서버를 제공하는지?
  - 프로세스 간 통신(IPC) 방법은?
- Node.js에서 Windows EXE 호출 방법
  - `child_process.exec` / `child_process.spawn`
  - Windows COM 인터페이스 사용 (`win32ole` 패키지 등)
  - 제조사 툴을 서비스로 래핑하는 별도 프로그램 필요 여부
- 제조사 툴이 제공하는 기능 중 우리가 직접 구현할 부분과 툴을 활용할 부분 구분
- 병합/화면관리 기능은 제조사 툴에 위임하고, 우리는 명령 실행만 담당할지?

**질문**:
1. 제조사 멀티제어 툴의 정확한 이름과 버전은?
2. 해당 툴이 제공하는 API/인터페이스 형태는? (CLI, COM, HTTP API 등)
3. 제조사 툴 사용 설명서 또는 개발자 문서를 확보할 수 있는지?
4. 제조사 툴을 통해 실행할 명령과 우리가 직접 실행할 명령을 어떻게 구분할지?
5. 제조사 툴이 260대 동시 제어를 지원하는지? (성능/제한사항)

---

### 3. 명령 실행 확인 프로세스

**현재 구현**:
- 워커 에이전트가 명령 실행 후 `ExecutionResult`를 제어서버로 전송
- 타임아웃 설정 (기본 60초)
- 재시도 로직 포함

**미결정 사항**:
- **제조사 툴을 통해 명령을 실행한 경우, 어떻게 성공/실패를 확인할지?**
  - 제조사 툴이 반환하는 응답 코드/메시지 형식
  - 타임아웃 설정 (제조사 툴 특성에 따라 달라질 수 있음)
  - 부분 성공/부분 실패 케이스 처리
- **ADB 직접 실행 vs 제조사 툴 실행 혼용 시 일관성 유지 방법**
- **명령 실행 로그 저장 위치 및 형식**
  - 제조사 툴 로그와 우리 시스템 로그 통합 방법

**질문**:
1. 제조사 툴이 명령 실행 결과를 어떻게 반환하는지? (성공/실패 판단 기준)
2. 제조사 툴 실행 시간이 예상보다 길 경우 타임아웃을 어떻게 설정할지?
3. 명령 실행 실패 시 상세 오류 정보를 얻을 수 있는지?

---

### 4. 오류 처리 프로세스 (알림, 스크린샷)

**현재 구현**:
- 워커 에이전트에서 오류 발생 시 스크린샷 캡처 (`adbController.takeScreenshot`)
- 스크린샷 경로를 `ExecutionResult`에 포함하여 제어서버로 전송
- 제어서버는 결과를 Redis/DB에 저장

**미결정 사항**:
- **스크린샷을 누가 캡처하는가?**
  - 현재: 워커 에이전트 (ADB 직접 사용)
  - 제조사 툴 사용 시: 제조사 툴의 스크린샷 기능을 사용할지, ADB를 직접 사용할지?
- **스크린샷 저장 위치**
  - 워커PC 로컬 저장?
  - 제어서버로 전송하여 중앙 저장?
  - 클라우드 스토리지 (S3, Azure Blob 등)?
- **알림 시스템**
  - 현재: 웹 대시보드에서 상태 확인 (Pull 방식)
  - 실시간 알림이 필요한지? (Push 알림: 이메일, Slack, Telegram 등)
  - 알림 조건: 오류 발생 시, 특정 오류율 초과 시, 기기 오프라인 시 등
- **오류 복구 프로세스**
  - ADB 재연결 시도 (현재 구조에는 포함되어 있으나 상세 미정)
  - 앱 재시작 로직
  - 기기 재부팅 필요 시 처리

**질문**:
1. 제조사 툴에 스크린샷 기능이 있는지? 있다면 ADB 직접 사용과 어떤 차이가 있는지?
2. 스크린샷은 워커PC에 로컬 저장 후 필요 시 제어서버가 조회할지, 아니면 즉시 제어서버로 전송할지?
3. 실시간 알림이 필요한지? 필요한 경우 어떤 채널을 선호하는지? (이메일, Slack, Telegram 등)
4. 오류 복구 프로세스의 자동화 수준은 어느 정도까지인지? (자동 재시도만 vs 자동 재부팅까지)

---

### 5. 네트워크 및 하드웨어 구성 세부사항

**문서상 명시된 내용**:
- WiFi 라우터 2대, 각각 130대 담당
- 워커PC는 듀얼 LAN 포트 (외부 연결 + WiFi 라우터 연결)
- WiFi는 폐쇄망 (WAN 비활성화)
- VPN을 통한 제어서버 접근

**추가 확인 필요사항**:
- **워커PC와 제어서버 간 통신**
  - 현재: WebSocket 연결 (`ws://` 또는 `wss://`)
  - 네트워크 경로: 워커PC 외부 LAN → 인터넷 → VPN → 제어서버
  - 방화벽 규칙: 워커PC에서 제어서버로의 아웃바운드 연결 허용 필요
  - 고정 IP 필요 여부
- **워커PC 하드웨어 세부사항**
  - USB 3.0 Hub: 130포트 확장이 실제로 가능한지? (일반적으로 USB Hub는 계단식으로 연결)
  - 전원 공급: 130대 동시 충전 시 전력 소비량
  - 냉각: 장시간 운영 시 온도 관리
- **WiFi 라우터 사양**
  - 실제 150+ 클라이언트 동시 연결 지원 모델 선정
  - WiFi 표준 (802.11ac, 802.11ax 등)
  - 대역폭: 130대가 동시에 ADB over WiFi 사용 시 네트워크 병목 가능성

**질문**:
1. 워커PC와 제어서버 간 네트워크 연결은 어떻게 구성할지? (인터넷을 통한 VPN vs 사설망)
2. 워커PC 외부 IP는 고정 IP인지? 동적 IP인지?
3. USB Hub 구성 방안 (130포트를 어떻게 확보할지)?
4. WiFi 라우터 모델 선정 계획 (특정 모델이 정해졌는지)?
5. 네트워크 대역폭 예상 사용량 (ADB 명령 빈도에 따라)

---

### 6. 데이터 저장 및 로깅

**현재 구현**:
- Redis: 디바이스 상태, 작업 큐
- PostgreSQL: 문서에는 명시되어 있으나 코드에는 미구현
- 파일 시스템: 스크린샷 저장 (현재는 경로만 반환)

**미결정 사항**:
- **작업 실행 로그 저장 위치 및 형식**
  - 모든 작업 결과를 DB에 저장할지?
  - 로그 보관 기간 (1개월, 1년 등)
  - 로그 파일 형식 (JSON, CSV 등)
- **스크린샷 저장소**
  - 워커PC 로컬 저장 vs 제어서버 중앙 저장 vs 클라우드 스토리지
  - 저장 용량 관리 (오래된 스크린샷 자동 삭제 정책)
- **모니터링 데이터 저장**
  - Prometheus + Grafana 사용 시 메트릭 보관 기간
  - 알람 이력 저장

**질문**:
1. 작업 로그는 얼마나 오래 보관할지?
2. 스크린샷은 워커PC에 로컬 저장만 할지, 아니면 제어서버로 백업할지?
3. PostgreSQL 도입 계획이 있는지? 있다면 스키마 설계 필요

---

### 7. 확장성 및 운영

**현재 구성**: 260대 (워커PC 2대 × 130대)

**고려사항**:
- 향후 확장 계획 (300대, 500대 등)
- 워커PC 추가 시 제어서버 부하 증가 대응
- 다중 제어서버 구성 필요 여부 (고가용성)

**질문**:
1. 향후 확장 계획이 있는지? (예: 1년 내 500대까지 확장)
2. 시스템 다운타임 허용 범위 (24/7 운영 필수인지?)
3. 백업 및 재해 복구 계획

---

## 기술 스택 요약

### 제어서버
- **언어**: TypeScript (Node.js)
- **프레임워크**: Express.js
- **실시간 통신**: WebSocket (`ws` 패키지)
- **데이터베이스**: Redis (상태 관리), PostgreSQL (문서상 명시, 미구현)
- **인증**: JWT (jsonwebtoken)
- **배포**: 미정 (Ubuntu VM or Windows Server)

### 워커 에이전트
- **언어**: TypeScript (Node.js)
- **실시간 통신**: WebSocket Client
- **기기 제어**: ADB (Android Debug Bridge)
- **OS**: **Windows 확정** ✅
- **제조사 툴 통합**: 미정 (통합 방법 결정 필요)

### 웹 대시보드
- **기술**: HTML + JavaScript (Vanilla)
- **UI 프레임워크**: Web Awesome
- **빌드 도구**: 없음 (정적 파일)

---

## 다음 단계 제안

### 단기 (1-2주)

1. **제조사 멀티제어 툴 분석**
   - 툴 문서 확보
   - API/인터페이스 형태 파악
   - Node.js 통합 방법 검토

2. **제어서버 OS 결정**
   - Ubuntu vs Windows Server 비교
   - 클라우드 배포 환경 결정

3. **네트워크/하드웨어 구성 확정**
   - WiFi 라우터 모델 선정
   - USB Hub 구성 방안 확정
   - 네트워크 방화벽 규칙 정의

### 중기 (1개월)

4. **제조사 툴 통합 구현**
   - 워커 에이전트에 제조사 툴 호출 로직 추가
   - ADB 직접 실행 vs 제조사 툴 실행 구분 로직

5. **오류 처리 및 알림 시스템 구현**
   - 스크린샷 저장소 구성
   - 알림 시스템 구축 (필요 시)

6. **데이터베이스 설계 및 구현**
   - PostgreSQL 스키마 설계
   - 작업 로그 저장 로직 구현

### 장기 (2-3개월)

7. **실제 하드웨어 구매 및 설치**
8. **260대 전체 시스템 통합 테스트**
9. **운영 모니터링 시스템 구축**

---

## 참고 문서

- `docs/ARCHITECTURE.md` - 전체 아키텍처 상세
- `docs/SEARCH_REQUEST_FLOW.md` - 검색 요청 플로우
- `docs/setup/POC_SETUP.md` - PoC 설정 가이드
- `docs/setup/QUICK_START.md` - 빠른 시작 가이드

---

## 기획 AI 에이전트에게 요청

위의 **"🔴 결정/판단이 필요한 주요 사항"** 섹션에 명시된 질문들에 대해:

1. **하드웨어 및 네트워크 구성 최적안** 제시
2. **제조사 툴 통합 방법** 제시 (가능한 시나리오별로)
3. **제어서버 OS 선택 근거** 제시
4. **오류 처리 및 알림 시스템 설계안** 제시
5. **데이터 저장 및 로깅 전략** 제시

각 항목에 대해 **비용, 복잡도, 확장성, 운영 편의성**을 고려한 비교 분석을 요청합니다.

